##
## Jeffrey Friedl (jfriedl@omron.co.jp)
## Copyri.... ah hell, just take it.
##
## Prettied up October 94.
##
package kana2romaji;
$version = "941005.02";

##
## BLURB:
##   &kana2romaji'convert -- convert EUC kana to romaji
##
##>
##
##  $romaji = &kana2romaji'convert($kana);
##
##  Converts the given kana (encoded in EUC) to romaji.
##  Return undef if there is an error.
##
##<
##

$katakana_dash = "\241\274";          ## 'ー'
$small_tsu = '[\244\245]\303';        ## regex to match 'ッ' or 'っ'
#$kana_char = '[\244\245][\x81-\xf6]'; ## regex to match a kana character.
$euc_char = '[\x80-\xff][\x80-\xff]'; ## regex to match an EUC character

sub kana2romaji
{
    &convert;
}

sub convert
{
    local($kana) = @_;
    local($romaji) = '';
    local($try, $new);

    MAINLOOP: while (length $kana)
    {
	##
	## If there is some prepended ASCII, just pass to the romaji.
	##
	if ($kana =~ s/^([\x00-\x7f]+)//) {
	    $romaji .= $1;
	    last unless length $kana; ## quick abort if we're done.
	}

	##
	## If the kana begins with a dash, just replicate the
	## final character of the romaji.
	##
	if (length($romaji) && $kana =~ s/^($katakana_dash)+//o) {
	    $romaji =~ s/(.)$/$1$1/;
	    next;
	}

	##
	## If the next character is a small TSU, note that the character
	## following it will have to have its romaji preceeded by a voiced
	## stop (replicating the first character of the romaji).
	##
	$voiced_stop = ($kana =~ s/^($small_tsu)+//o);

	##
	## The longest bit of kana we'll ever check against the transliteration
	## tables would be three characters, so grab at most three for
	## checking:
	##
        unless ($kana =~ s/^(($euc_char){1,3})//o) {
	    ##
	    ## At this point, we couldn't translate the first character....
	    ## Just pass it through to $romaji.
	    ##
	    $kana =~ s/([\x00-\x7f]|[\x80-\xff].)//;
	    $romaji .= $1;
	} else {
	    ($try) = $1;

	    while (length $try)
	    {
		if (defined($new = $tr{$try})) {
		    ## found the transliteration
		    $romaji .= substr($new, 0, 1) if $voiced_stop;
		    $romaji .="'" if $romaji =~ m/n$/ && $new =~ m/^[aiueoy]/;
		    $romaji .= $new;
		    next MAINLOOP;
		}

	        last if length($try) <= 2;
		$try =~ s/(..)$//;  ## nab last char of $try....
		$kana= "$1$kana";   ## ... and prepend back to $kana
	    }

	    ##
	    ## At this point, we couldn't translate $try.
	    ## Just pass it through to $romaji.
	    ##
	    $romaji .= $try;
	}
    }
    $romaji =~ s/^\s+//;  ## make sure no leading or
    $romaji =~ s/\s+$//;  ##   trailing spaces.
    return $romaji;
}


##
## Transliteration table.
## $tr{$kana} = $romaji;
##
%tr = (
	 "\xa4\xa2", 'a',                                    # あ
	 "\xa4\xa4", 'i',                                    # い
	 "\xa4\xa6", 'u',                                    # う
	 "\xa4\xa8", 'e',                                    # え
	 "\xa4\xaa", 'o',                                    # お

	 "\xa4\xab", 'ka',             "\xa4\xac", 'ga',     # か, が
	 "\xa4\xad", 'ki',             "\xa4\xae", 'gi',     # き, ぎ
	 "\xa4\xaf", 'ku',             "\xa4\xb0", 'gu',     # く, ぐ
	 "\xa4\xb1", 'ke',             "\xa4\xb2", 'ge',     # け, げ
	 "\xa4\xb3", 'ko',             "\xa4\xb4", 'go',     # こ, ご


 "\xa4\xad\xa4\xe3", 'kya',    "\xa4\xae\xa4\xe3", 'gya',    # きゃ, ぎゃ
 "\xa4\xad\xa4\xe5", 'kyu',    "\xa4\xae\xa4\xe5", 'gyu',    # きゅ, ぎゅ
 "\xa4\xad\xa4\xe7", 'kyo',    "\xa4\xae\xa4\xe7", 'gyo',    # きょ, ぎょ


 "\xa4\xaf\xa4\xa1", 'kwa',                                  # くぁ
 "\xa4\xaf\xa4\xa9", 'kwo',                                  # くぉ

	 "\xa4\xb5", 'sa',             "\xa4\xb6", 'za',     # さ, ざ
	 "\xa4\xb7", 'shi',            "\xa4\xb8", 'ji',     # し, じ
	 "\xa4\xb9", 'su',             "\xa4\xba", 'zu',     # す, ず
	 "\xa4\xbb", 'se',             "\xa4\xbc", 'ze',     # せ, ぜ
	 "\xa4\xbd", 'so',             "\xa4\xbe", 'zo',     # そ, ぞ


 "\xa4\xb7\xa4\xe3", 'sha',    "\xa4\xb8\xa4\xe3", 'ja',     # しゃ, じゃ
 "\xa4\xb7\xa4\xe5", 'shu',    "\xa4\xb8\xa4\xe5", 'ju',     # しゅ, じゅ
 "\xa4\xb7\xa4\xa7", 'she',    "\xa4\xb8\xa4\xa7", 'je',     # しぇ, じぇ
 "\xa4\xb7\xa4\xe7", 'sho',    "\xa4\xb8\xa4\xe7", 'jo',     # しょ, じょ

 "\xa4\xb9\xa4\xa7", 'suwe',                                 # すぇ

	 "\xa4\xbf", 'ta',             "\xa4\xc0", 'da',     # た, だ
	 "\xa4\xc1", 'chi',            "\xa4\xc2", 'ji',     # ち, ぢ
	 "\xa4\xc4", 'tsu',            "\xa4\xc5", 'dzu',    # つ, づ
	 "\xa4\xc6", 'te',             "\xa4\xc7", 'de',     # て, で
	 "\xa4\xc8", 'to',             "\xa4\xc9", 'do',     # と, ど

 "\xa4\xc1\xa4\xe3", 'cha',                                  # ちゃ
 "\xa4\xc1\xa4\xe5", 'chu',                                  # ちゅ
 "\xa4\xc1\xa4\xa7", 'che',                                  # ちぇ
 "\xa4\xc1\xa4\xe7", 'cho',    "\xa4\xc2\xa4\xe7", 'jyo',    # ちょ, ぢょ

 "\xa4\xc4\xa4\xa1", 'tsa',                                  # つぁ
 "\xa4\xc6\xa4\xa3", 'ti',     "\xa4\xc7\xa4\xa3", 'di',     # てぃ, でぃ

	 "\xa4\xca", 'na',                                   # な
	 "\xa4\xcb", 'ni',                                   # に
	 "\xa4\xcc", 'nu',                                   # ぬ
	 "\xa4\xcd", 'ne',                                   # ね
	 "\xa4\xce", 'no',                                   # の
 "\xa4\xcb\xa4\xe3", 'nya',                                  # にゃ
 "\xa4\xcb\xa4\xe5", 'nyu',                                  # にゅ
 "\xa4\xcb\xa4\xe7", 'nyo',                                  # にょ

     "\xa4\xcf", 'ha',     "\xa4\xd0", 'ba',   "\xa4\xd1",'pa', # は, ば, ぱ
     "\xa4\xd2", 'hi',     "\xa4\xd3", 'bi',   "\xa4\xd4",'pi', # ひ, び, ぴ
     "\xa4\xd5", 'fu',     "\xa4\xd6", 'bu',   "\xa4\xd7",'pu', # ふ, ぶ, ぷ
     "\xa4\xd8", 'he',     "\xa4\xd9", 'be',   "\xa4\xda",'pe', # へ, べ, ぺ
     "\xa4\xdb", 'ho',     "\xa4\xdc", 'bo',   "\xa4\xdd",'po', # ほ, ぼ, ぽ

  #ひゃ,びゃ,ぴゃ
  "\xa4\xd2\xa4\xe3",'hya',"\xa4\xd3\xa4\xe3",'bya',"\xa4\xd4\xa4\xe3",'pya',

  #ひゅ,びゅ,ぴゅ
  "\xa4\xd2\xa4\xe5",'hyu',"\xa4\xd3\xa4\xe5",'byu',"\xa4\xd4\xa4\xe5",'pyu',

  #ひょ,びょ,ぴょ
  "\xa4\xd2\xa4\xe7",'hyo',"\xa4\xd3\xa4\xe7",'byo',"\xa4\xd4\xa4\xe7",'pyo',

 "\xa4\xd5\xa4\xa1", 'fa',                                   # ふぁ
 "\xa4\xd5\xa4\xa3", 'fi',                                   # ふぃ
 "\xa4\xd5\xa4\xa7", 'fe',                                   # ふぇ
 "\xa4\xd5\xa4\xa9", 'fo',                                   # ふぉ

	 "\xa4\xde", 'ma',                                   # ま
	 "\xa4\xdf", 'mi',                                   # み
	 "\xa4\xe0", 'mu',                                   # む
	 "\xa4\xe1", 'me',                                   # め
	 "\xa4\xe2", 'mo',                                   # も

 "\xa4\xdf\xa4\xe3", 'mya',                                  # みゃ
 "\xa4\xdf\xa4\xe5", 'myu',                                  # みゅ
 "\xa4\xdf\xa4\xe7", 'myo',                                  # みょ

	 "\xa4\xe4", 'ya',                                   # や
	 "\xa4\xe6", 'yu',                                   # ゆ
	 "\xa4\xe8", 'yo',                                   # よ

	 "\xa4\xe9", 'ra',                                   # ら
	 "\xa4\xea", 'ri',                                   # り
	 "\xa4\xeb", 'ru',                                   # る
	 "\xa4\xec", 're',                                   # れ
	 "\xa4\xed", 'ro',                                   # ろ

 "\xa4\xea\xa4\xa7", 'rye',                                  # りぇ
 "\xa4\xea\xa4\xe3", 'rya',                                  # りゃ
 "\xa4\xea\xa4\xe5", 'ryu',                                  # りゅ
 "\xa4\xea\xa4\xe7", 'ryo',                                  # りょ

	 "\xa4\xef", 'wa',                                   # わ
	 "\xa4\xf2", 'wo',                                   # を
	 "\xa4\xf3", 'n',                                    # ん

	 "\xa4\xf0", 'wi',                                   # ゐ
	 "\xa4\xf1", 'we',                                   # ゑ
	 "\xa5\xf1", 'e',                                    # ヱ

 "\xa4\xa4\xa4\xa7", 'ixe',                                  # いぇ
 "\xa4\xa6\xa4\xa3", 'wi',                                   # うぃ
 "\xa4\xa6\xa4\xa7", 'we',                                   # うぇ
 "\xa5\xa6\xa5\xa9", 'wo',                                   # ウォ
	 "\xa5\xf4", 'vu',                                   # ヴ

							     # ヴァ
 "\xa5\xf4\xa5\xa3", 'vi',                                   # ヴィ
 "\xa5\xf4\xa5\xa7", 've',                                   # ヴェ
 "\xa5\xf4\xa5\xa9", 'vo',                                   # ヴォ
 "\xa5\xf4\xa5\xe5", 'vyu',                                  # ヴュ

	 "\xa4\xa1", 'xa',                                   # ぁ
	 "\xa4\xa3", 'xi',                                   # ぃ
	 "\xa4\xa5", 'xu',                                   # ぅ
	 "\xa4\xa7", 'xe',                                   # ぇ
	 "\xa4\xa9", 'xo',                                   # ぉ
	 "\xa4\xe3", 'xya',                                  # ゃ
	 "\xa4\xe5", 'xyu',                                  # ゅ
	 "\xa4\xe7", 'xyo',                                  # ょ
	 "\xa4\xee", 'xwa',                                  # ゎ
	 "\xa5\xf6", 'xke',                                  # ヶ
	 "\xa5\xf5", 'xka',                                  # ヵ


	 "\xa1\xb9", ' kanjinoodoriji ',                     # 々
	 "\xa1\xf5", ' anddo ',                              # ＆
	 "\xa6\xc2", ' beta ',                               # β

	 "\xa3\xb0", ' zero ',                               # ０
	 "\xa3\xb1", ' uan ',                                # １
	 "\xa3\xb2", ' tuu ',                                # ２
	 "\xa3\xb3", ' turii ',                              # ３
	 "\xa3\xb4", ' foaa ',                               # ４
	 "\xa3\xb5", ' faibu ',                              # ５
	 "\xa3\xb6", ' shikusu ',                            # ６
	 "\xa3\xb7", ' sebin ',                              # ７
	 "\xa3\xb8", ' eito ',                               # ８
	 "\xa3\xb9", ' nainu ',                              # ９

	 "\xa3\xc1", ' ee ',                                 # Ａ
	 "\xa3\xe1", ' ee ',                                 # ａ
	 "\xa3\xc2", ' bii ',                                # Ｂ
	 "\xa3\xe2", ' bii ',                                # ｂ
	 "\xa3\xc3", ' shii ',                               # Ｃ
	 "\xa3\xe3", ' shii ',                               # ｃ
	 "\xa3\xc4", ' di  ',                                # Ｄ
	 "\xa3\xe4", ' di  ',                                # ｄ
	 "\xa3\xc5", ' ii ',                                 # Ｅ
	 "\xa3\xe5", ' ii ',                                 # ｅ
	 "\xa3\xc6", ' efu ',                                # Ｆ
	 "\xa3\xe6", ' efu ',                                # ｆ
	 "\xa3\xc7", ' ji ',                                 # Ｇ
	 "\xa3\xe7", ' ji ',                                 # ｇ
	 "\xa3\xc8", ' echi ',                               # Ｈ
	 "\xa3\xe8", ' echi ',                               # ｈ
	 "\xa3\xc9", ' ai ',                                 # Ｉ
	 "\xa3\xe9", ' ai ',                                 # ｉ
	 "\xa3\xca", ' jei ',                                # Ｊ
	 "\xa3\xea", ' jei ',                                # ｊ
	 "\xa3\xcb", ' kei ',                                # Ｋ
	 "\xa3\xeb", ' kei ',                                # ｋ
	 "\xa3\xcc", ' eru ',                                # Ｌ
	 "\xa3\xec", ' eru ',                                # ｌ
	 "\xa3\xcd", ' emu ',                                # Ｍ
	 "\xa3\xed", ' emu ',                                # ｍ
	 "\xa3\xce", ' en ',                                 # Ｎ
	 "\xa3\xee", ' en ',                                 # ｎ
	 "\xa3\xcf", ' oo ',                                 # Ｏ
	 "\xa3\xef", ' oo ',                                 # ｏ
	 "\xa3\xd0", ' pii ',                                # Ｐ
	 "\xa3\xf0", ' pii ',                                # ｐ
	 "\xa3\xd1", ' kyuu ',                               # Ｑ
	 "\xa3\xf1", ' kyuu ',                               # ｑ
	 "\xa3\xd2", ' aru ',                                # Ｒ
	 "\xa3\xf2", ' aru ',                                # ｒ
	 "\xa3\xd3", ' esu ',                                # Ｓ
	 "\xa3\xf3", ' esu ',                                # ｓ
	 "\xa3\xd4", ' tii ',                                # Ｔ
	 "\xa3\xf4", ' tii ',                                # ｔ
	 "\xa3\xd5", ' iuu ',                                # Ｕ
	 "\xa3\xf5", ' iuu ',                                # ｕ
	 "\xa3\xd6", ' vi ',                                 # Ｖ
	 "\xa3\xf6", ' vi ',                                 # ｖ
	 "\xa3\xd7", ' daburu ',                             # Ｗ
	 "\xa3\xf7", ' daburu ',                             # ｗ
	 "\xa3\xd8", ' ekusu ',                              # Ｘ
	 "\xa3\xf8", ' ekusu ',                              # ｘ
	 "\xa3\xd9", ' uai ',                                # Ｙ
	 "\xa3\xf9", ' uai ',                                # ｙ
	 "\xa3\xda", ' zedo ',                               # Ｚ
	 "\xa3\xfa", ' zedo ',                               # ｚ
);

##init
{
    local ($key, @chars, $kata);

    ## replicate to a katakana version
    foreach $key (keys(%tr)) {
	@chars = $key =~ m/(..)/g;       ## Break out indiviual characters.
	grep(s/^\xa4/\xa5/,  @chars);    ## Change any hiragana to katakana.
	$kata = join('', @chars);                ## put back together.
	$tr{$kata} = $tr{$key} if $kata ne $key; ## set katakana->romaji reln
    }
}

1;


__END__
